"""Script para probar el sistema de explotación paso a paso."""
import socket
import json
import time

def test_ssh_connection(host='127.0.0.1', port=2201):
    """Prueba si el puerto SSH está abierto."""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(3)
        result = sock.connect_ex((host, port))
        sock.close()
        
        if result == 0:
            print(f"\033[92m[+] {host}:{port} está ABIERTO\033[0m")
            return True
        else:
            print(f"\033[91m[!] {host}:{port} está CERRADO\033[0m")
            return False
    except Exception as e:
        print(f"\033[91m[!] Error: {e}\033[0m")
        return False

def test_ssh_banner(host='127.0.0.1', port=2201):
    """Obtiene el banner SSH."""
    try:
        sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        sock.settimeout(3)
        sock.connect((host, port))
        banner = sock.recv(1024).decode('utf-8', errors='ignore')
        sock.close()
        
        print(f"\033[93m[*] Banner: {banner.strip()}\033[0m")
        return banner
    except Exception as e:
        print(f"\033[91m[!] Error obteniendo banner: {e}\033[0m")
        return None

def test_ssh_credentials(host='127.0.0.1', port=2201):
    """Prueba credenciales SSH con paramiko."""
    try:
        import paramiko
        
        creds = [('admin', 'admin'), ('test', 'test'), ('root', 'root')]
        
        for user, pwd in creds:
            try:
                print(f"\033[93m[*] Probando {user}:{pwd}...\033[0m", end=" ")
                
                client = paramiko.SSHClient()
                client.set_missing_host_key_policy(paramiko.AutoAddPolicy())
                client.connect(host, port=port, username=user, password=pwd, timeout=5)
                
                print(f"\033[92m✓ EXITOSO\033[0m")
                
                # Ejecutar comando de prueba
                stdin, stdout, stderr = client.exec_command('whoami')
                result = stdout.read().decode('utf-8').strip()
                print(f"\033[96m    Usuario actual: {result}\033[0m")
                
                client.close()
                return True
                
            except paramiko.AuthenticationException:
                print(f"\033[91m✗ Credenciales incorrectas\033[0m")
            except Exception as e:
                print(f"\033[91m✗ Error: {e}\033[0m")
        
        return False
        
    except ImportError:
        print(f"\033[91m[!] Paramiko no está instalado\033[0m")
        print(f"\033[93m[*] Instala con: pip install paramiko\033[0m")
        return False

if __name__ == "__main__":
    print("\033[96m" + "="*60)
    print("       PRUEBA DE EXPLOTACIÓN SSH")
    print("="*60 + "\033[0m\n")
    
    ports = [2201, 2202, 2203]
    
    for port in ports:
        print(f"\n\033[94m>>> Probando 127.0.0.1:{port}\033[0m")
        
        if test_ssh_connection('127.0.0.1', port):
            test_ssh_banner('127.0.0.1', port)
            test_ssh_credentials('127.0.0.1', port)
        
        print()
    
    print("\033[96m" + "="*60)
    print("       PRUEBA COMPLETADA")
    print("="*60 + "\033[0m")
    
    input("\nPresiona Enter para continuar...")
